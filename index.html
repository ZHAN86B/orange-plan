<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="æ©™å­æˆé•¿">
    <title>ğŸŠ æ©™å­æˆé•¿Â·äº‘ç«¯å®è£…ç‰ˆ (V47)</title>
    <!-- å¼•å…¥ Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- 1. åŸºç¡€å˜é‡ --- */
        :root {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #333;
            --primary: #4dabf7;
            --secondary: #3bc9db;
            --accent: #ff8787;
            --habit-color: #69db7c;
            --plan-color: #ffc078;
            --focus-color: #748ffc; 
            --wish-color: #fcc419;
            --bank-color: #ffd43b;
            --daily-reward-color: #a5d8ff;
            --badge-bg: #f1f3f5;
            --admin-bar-bg: #e7f5ff;
            --shadow: 0 8px 20px rgba(0,0,0,0.1);
            --radius: 16px;
            --font: "Comic Sans MS", "å¹¼åœ†", "Microsoft YaHei", sans-serif;
        }

        /* --- 2. ä¸»é¢˜å®šä¹‰ --- */
        [data-theme="space"] { --bg-color: #0b0d17; --card-bg: #151932; --text-color: #e0e6ed; --primary: #7048e8; --secondary: #38d9a9; --accent: #ffd43b; --habit-color: #4c6ef5; --plan-color: #be4bdb; --focus-color: #5c7cfa; --wish-color: #ffd43b; --daily-reward-color: #3b5bdb; --badge-bg: #2c2e3e; --admin-bar-bg: #1c2540; --bank-color: #fab005; }
        [data-theme="sky"] { --bg-color: #8ECAE6; --card-bg: #ffffff; --text-color: #023047; --primary: #219EBC; --secondary: #FFB703; --accent: #FB8500; --habit-color: #69db7c; --plan-color: #ffc078; --focus-color: #4dabf7; --wish-color: #fab005; --daily-reward-color: #e7f5ff; --badge-bg: #f1f3f5; --admin-bar-bg: #d0ebff; --bank-color: #ffec99; }
        [data-theme="forest"] { --bg-color: #D8F3DC; --card-bg: #ffffff; --text-color: #1B4332; --primary: #52B788; --secondary: #95D5B2; --accent: #D90429; --habit-color: #40916c; --plan-color: #b7e4c7; --focus-color: #2b8a3e; --wish-color: #e67700; --daily-reward-color: #ebfbee; --badge-bg: #f1f3f5; --admin-bar-bg: #d3f9d8; --bank-color: #ffd43b; }
        [data-theme="candy"] { --bg-color: #FFE5EC; --card-bg: #FFF0F3; --text-color: #5c2c45; --primary: #FF8FAB; --secondary: #FB6F92; --accent: #FFC2D1; --habit-color: #ff99c8; --plan-color: #e0aaff; --focus-color: #be4bdb; --wish-color: #ff922b; --daily-reward-color: #fff0f6; --badge-bg: #fff0f6; --admin-bar-bg: #ffe3e3; --bank-color: #ffe066; }

        html, body { height: 100%; margin: 0; padding: 0; font-family: var(--font); color: var(--text-color); background-color: var(--bg-color); transition: background-color 0.5s ease; overflow-x: hidden; }
        
        #bg-anim-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: hidden; }
        [data-theme="space"] body { background-image: radial-gradient(rgba(255,255,255,0.15) 1px, transparent 1px); background-size: 50px 50px; }
        .anim-item { position: absolute; opacity: 0.8; user-select: none; will-change: transform; }

        /* åŠ¨ç”» */
        @keyframes floatRight { from { transform: translateX(-100px); } to { transform: translateX(120vw); } }
        @keyframes floatUp { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-120vh) rotate(180deg); } }
        @keyframes fallDown { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(120vh) rotate(360deg); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 8px rgba(255,255,255,0.8); } }
        @keyframes meteorSlide { 0% { transform: translate(0, 0) scale(1); opacity: 0; } 5% { opacity: 1; } 15% { transform: translate(-150vh, 150vh) scale(1); opacity: 0; } 100% { opacity: 0; } }
        @keyframes floatSpace { 0% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(0, 30px) rotate(0deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        @keyframes breath { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* --- 3. å¸ƒå±€ç³»ç»Ÿ --- */
        .app-container { position: relative; z-index: 1; max-width: 1000px; margin: 0 auto; padding: 20px; padding-top: 20px; }
        .top-section { margin-bottom: 20px; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 700px) { .main-grid { grid-template-columns: 1fr; } .app-container { padding: 15px; } }

        .panel { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); transition: 0.3s; margin-bottom: 20px; }
        
        /* å¤´éƒ¨å¸ƒå±€ */
        .header-section { grid-column: 1 / -1; background: var(--card-bg); padding: 15px 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: nowrap; gap: 15px; }
        .title-area { flex: 1; min-width: 140px; padding-top: 5px; }
        .header-right-group { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
        
        /* å·¥å…·æ  */
        .tools-bar { display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.04); padding: 4px 8px; border-radius: 20px; }
        .tool-btn { background: white; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; font-size: 13px; color: #555; font-weight: bold; padding: 3px 8px; border-radius: 12px; transition: 0.2s; display: flex; align-items: center; gap: 3px; font-family: var(--font); }
        .tool-btn:hover { transform: translateY(-2px); color: var(--primary); border-color: var(--primary); }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .theme-select { padding: 3px 6px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); font-size: 12px; color: #555; background: white; cursor: pointer; }
        
        /* ç§¯åˆ†å±•ç¤º & äº‘åŒæ­¥çŠ¶æ€ */
        .points-display-area { display: flex; flex-direction: column; align-items: flex-end; margin-top: 5px; margin-right: 5px; }
        .stars-label { font-size: 0.75em; background: #ffec99; color: #e67700; padding: 2px 8px; border-radius: 8px 8px 8px 0; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: -5px; margin-right: 10px; transform: rotate(-3deg); z-index: 2; white-space: nowrap;}
        .stars-number-box { display: flex; align-items: baseline; }
        .stars-number { font-size: 2.2rem; font-weight: 900; color: var(--wish-color); font-family: "Verdana", sans-serif; line-height: 1; text-shadow: 2px 2px 0px var(--accent), -1px -1px 0 white; white-space: nowrap; }
        .stars-icon { font-size: 1.5em; margin-left: 2px; animation: pulse 3s infinite; }
        
        /* äº‘åŒæ­¥æŒ‡ç¤ºå™¨ */
        #syncStatus { font-size: 12px; color: #999; margin-top: 5px; display: flex; align-items: center; gap: 4px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; display: inline-block; }
        .sync-dot.green { background: #51cf66; box-shadow: 0 0 5px #51cf66; }
        .sync-dot.yellow { background: #fcc419; animation: pulse 1s infinite; }
        .sync-dot.red { background: #ff6b6b; }

        /* é¢æ¿æ ‡é¢˜ */
        .panel h2 { margin-top: 0; border-bottom: 3px dashed var(--primary); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .habit-panel { border-top: 5px solid var(--habit-color); }
        .plan-panel { border-top: 5px solid var(--plan-color); }
        .reward-panel { border-top: 5px solid var(--accent); }
        .badge-panel { border-top: 5px solid #be4bdb; } 

        /* å‹‹ç« å¢™ */
        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .badge-card { background: var(--badge-bg); border: 2px solid rgba(0,0,0,0.05); border-radius: 15px; padding: 12px 5px; text-align: center; transition: 0.3s; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 110px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .badge-card.locked { opacity: 0.6; filter: grayscale(100%); background: #f9f9f9; border-color: #eee; }
        .badge-card.locked .badge-icon { opacity: 0.5; }
        .badge-card.locked .badge-status { color: #999; }
        .badge-card.unlocked { background: #fffbe6; border-color: #ffd43b; box-shadow: 0 5px 15px rgba(255, 212, 59, 0.3); transform: translateY(-3px); }
        .badge-card.unlocked .badge-icon { animation: breath 3s infinite ease-in-out; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .badge-card.unlocked .badge-status { background: #fab005; color: white; border-radius: 10px; padding: 2px 6px; font-weight: bold; }
        .badge-icon { font-size: 2.5em; display: block; margin-bottom: 8px; }
        .badge-name { font-size: 0.85em; color: var(--text-color); font-weight: bold; line-height: 1.3; margin-bottom: 5px; }
        .badge-status { font-size: 0.7em; color: #aaa; margin-top: auto; }
        .badge-card:hover::after { content: attr(data-desc); position: absolute; bottom: 90%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; font-size: 0.75em; padding: 8px 12px; border-radius: 8px; width: 140px; text-align: center; z-index: 20; pointer-events: none; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: normal; line-height: 1.4; }

        /* ä¸“æ³¨æ¨ªå¹… */
        .focus-banner { background: var(--card-bg); border-top: 5px solid var(--focus-color); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; position: relative; overflow: hidden; }
        .focus-banner::after { content: "â±ï¸"; position: absolute; right: -15px; bottom: -25px; font-size: 5em; opacity: 0.08; transform: rotate(-20deg); pointer-events: none;}
        .focus-info h3 { margin: 0; color: var(--focus-color); font-size: 1.5em; display: flex; align-items: center; gap: 10px; }
        .focus-info p { margin: 5px 0 0 0; color: #666; font-size: 0.95em; }
        .focus-btn-start { background: var(--focus-color); color: white; border: none; padding: 10px 25px; border-radius: 30px; font-size: 1em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(116, 143, 252, 0.3); transition: 0.2s; display: flex; align-items: center; gap: 8px; z-index: 2; }
        .focus-btn-start:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(116, 143, 252, 0.4); }

        /* å†å²è¶³è¿¹ */
        .history-section { margin-bottom: 20px; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); padding: 10px 20px; border-radius: var(--radius); border: 2px dashed var(--primary); box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .history-title { font-size: 0.8em; color: var(--primary); font-weight: bold; margin-bottom: 8px; }
        .history-scroll { display: flex; gap: 10px; justify-content: space-around; overflow-x: auto; padding-bottom: 2px; }
        .history-card { text-align: center; min-width: 36px; cursor: default; }
        .history-date { font-size: 0.7em; color: #999; margin-bottom: 4px; }
        .history-bubble { width: 36px; height: 36px; border-radius: 50%; background: #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; color: #555; font-size: 0.8em; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s ease; position: relative; }
        .history-bubble:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 2; }
        .history-bubble span { font-size: 1.1em; line-height: 1; }
        .h-level-0 { background: #f1f3f5; color: #adb5bd; border-color: #dee2e6; }
        .h-level-1 { background: #d3f9d8; color: #2b8a3e; border-color: #b2f2bb; }
        .h-level-2 { background: #ffd8a8; color: #e67700; border-color: #ffc078; }
        .h-level-3 { background: #ffc9c9; color: #c92a2a; border-color: #ffa8a8; }

        /* é“¶è¡Œå¡ç‰‡ */
        .bank-card { background: linear-gradient(135deg, #fff9db, #fff); border: 2px solid var(--bank-color); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255, 212, 59, 0.2); position: relative; overflow: hidden; }
        .bank-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #e9ecef; padding-bottom: 8px;}
        .bank-title { font-weight: bold; font-size: 1.1em; color: #e67700; display: flex; align-items: center; gap: 5px; }
        .bank-dashboard-new { display: flex; align-items: center; justify-content: space-between; }
        .bank-item-new { flex: 1; text-align: center; }
        .bank-label-new { font-size: 0.75em; color: #868e96; margin-bottom: 2px; }
        .bank-val-new { font-size: 1.2em; font-weight: bold; color: #495057; }
        .bank-icon-arrow { font-size: 1.2em; color: #ced4da; animation: pulse 2s infinite; }
        .bank-actions-row { display: flex; justify-content: space-around; margin-top: 10px; gap: 10px;}
        .btn-bank-act { flex: 1; border: none; padding: 8px; border-radius: 20px; font-size: 0.9em; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-bank-dep { background: var(--habit-color); color: white; }
        .btn-bank-wit { background: #fff; border: 1px solid #adb5bd; color: #495057; }
        .btn-bank-act:hover { transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ç›²ç›’ */
        .mystery-box-card { background: linear-gradient(135deg, #63e6be, #20c997); border: 2px solid white; color: white; border-radius: 15px; padding: 10px; text-align: center; cursor: pointer; position: relative; overflow: hidden; font-size: 0.9em; box-shadow: 0 4px 10px rgba(32, 201, 151, 0.3); }
        .mystery-box-card:hover { animation: shake 0.5s infinite; }
        .mystery-icon { font-size: 2.2em; display: block; margin-bottom: 2px; }

        /* å®åº“ */
        .inventory-header { font-size: 1.1em; font-weight: bold; padding: 8px 15px; border-radius: 10px; margin: 20px 0 15px 0; background: #e9ecef; color: #495057; display: flex; align-items: center; gap: 8px; }
        .inventory-item { background: #fff; border: 2px solid #eee; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .inventory-item:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .inventory-icon { font-size: 2em; }
        .inventory-name { font-weight: bold; font-size: 0.9em; }
        .inventory-btn { background: var(--habit-color); color: white; border: none; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; cursor: pointer; }
        .inventory-empty { text-align: center; padding: 20px; border: 2px dashed #eee; border-radius: 15px; color: #aaa; font-size: 0.9em; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .inventory-empty-icon { font-size: 2em; opacity: 0.5; }

        /* å¿ƒæ„¿å­˜é’±ç½ */
        .wish-jar-container { background: white; border: 2px solid var(--wish-color); border-radius: 15px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(252, 196, 25, 0.15); text-align: center; }
        .wish-empty-card { padding: 15px; cursor: pointer; }
        .wish-empty-icon { font-size: 2.5em; margin-bottom: 10px; display: block; animation: pop 0.5s; }
        .wish-empty-text { color: #888; font-size: 0.9em; margin-bottom: 15px; }
        .wish-active-card { text-align: left; }
        .wish-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .wish-title-text { font-weight: bold; font-size: 1.1em; color: #e67700; display: flex; align-items: center; gap: 5px; }
        .wish-progress-bg { width: 100%; height: 20px; background: #eee; border-radius: 10px; overflow: hidden; position: relative; }
        .wish-progress-fill { height: 100%; background: repeating-linear-gradient(45deg, var(--wish-color), var(--wish-color) 10px, #ffe066 10px, #ffe066 20px); width: 0%; transition: width 1s ease-out; }
        .wish-stats { display: flex; justify-content: space-between; font-size: 0.8em; margin-top: 5px; color: #666; }
        .wish-btn-set { background: var(--wish-color); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9em; font-weight: bold; box-shadow: 0 3px 8px rgba(252, 196, 25, 0.3); transition: 0.2s;}
        .wish-btn-set:hover { transform: scale(1.05); }
        .wish-btn-edit { background: #eee; color: #666; border: none; padding: 4px 10px; border-radius: 10px; cursor: pointer; font-size: 0.8em; }
        .wish-btn-redeem { width: 100%; background: var(--accent); color: white; border: none; padding: 10px; border-radius: 12px; font-weight: bold; margin-top: 15px; cursor: pointer; font-size: 1em; box-shadow: 0 4px 10px rgba(255,135,135,0.3); }

        .reward-sub-header { font-size: 1.1em; font-weight: bold; padding: 8px 15px; border-radius: 10px; margin: 20px 0 15px 0; display: flex; align-items: center; justify-content: space-between; gap: 8px; color: #555; border-bottom: 2px solid #f0f0f0; }
        .list-item { background: rgba(0,0,0,0.05); margin-bottom: 10px; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; border-left: 4px solid transparent; }
        .list-item:hover { transform: translateX(5px); background: rgba(0,0,0,0.08); }
        .habit-item { border-left-color: var(--habit-color); }
        .plan-item { border-left-color: var(--plan-color); }
        .plan-pending { border-left-color: #ccc; background: #f8f9fa; opacity: 0.8; }
        .streak-fire { font-size: 1.2em; margin-left: 5px; display: inline-block; animation: pulse 1s infinite; }

        .btn { border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; font-family: var(--font); transition: 0.2s; }
        .btn-check { background: var(--primary); color: white; }
        .btn-set-score { background: #ffc078; color: white; }
        .btn-del { background: transparent; color: #ff8787; font-size: 1.2em; margin-left: 5px; width: 30px; height:30px; cursor:pointer;}
        .btn-add { background: var(--secondary); color: white; flex-shrink: 0;}
        .btn-quick { background: var(--accent); color: white; border-radius: 50%; width: 35px; height: 35px; display:flex; align-items:center; justify-content:center; cursor:pointer; margin-right:5px;}
        .input-area { margin-top: 15px; display: flex; gap: 5px; align-items: center;}
        .input-area input { flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 10px; font-family: var(--font); }
        .input-area .val-input { width: 50px; }

        .reward-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .reward-card { background: var(--card-bg); border: 2px solid rgba(0,0,0,0.1); border-radius: 15px; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; font-size: 0.9em;}
        .reward-card:hover { border-color: var(--accent); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(255, 135, 135, 0.3); }
        .reward-icon { font-size: 2em; display: block; margin-bottom: 5px; }

        .pwd-btn { font-size: 0.8em; background: #eee; padding: 6px 12px; border-radius: 8px; margin-left: 5px; cursor: pointer; color: #666; border: 1px solid #ddd; display: flex; align-items: center; gap: 5px;}
        .level-badge { background: var(--primary); color: white; font-size: 0.4em; padding: 3px 8px; border-radius: 10px; vertical-align: middle; margin-right: 5px; }

        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal { background: var(--card-bg); padding: 20px; border-radius: 15px; width: 300px; max-height: 80vh; overflow-y: auto; text-align: center;}
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .preset-btn { background: rgba(0,0,0,0.05); border: 1px solid #eee; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; }
        .preset-btn:hover { background: var(--secondary); color: white; }

        /* å¿ƒæƒ…å¼¹çª—ç¾åŒ– */
        .mood-modal-content { background: linear-gradient(145deg, #ffffff, #f0f7ff); border-radius: 25px; padding: 30px; text-align: center; max-width: 400px; width: 90%; animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 4px solid #a5d8ff; box-shadow: 0 15px 40px rgba(77, 171, 247, 0.2); }
        .mood-title { color: var(--primary); font-size: 1.4em; margin-bottom: 10px; font-weight: bold; }
        .mood-grid { display: flex; justify-content: space-around; margin: 25px 0; gap: 10px; }
        .mood-btn { font-size: 3em; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); padding: 15px; border-radius: 20px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 90px; height: 90px; }
        .mood-btn small { font-size: 14px; color: #666; font-weight: bold; margin-top: 5px; display: block; }
        .mood-btn:hover { transform: translateY(-5px) scale(1.05); border-color: var(--primary); background: #e7f5ff; box-shadow: 0 10px 20px rgba(77, 171, 247, 0.2); }
        .mood-display { font-size: 1.5em; margin-left: 10px; vertical-align: middle; }
        
        .mood-report-modal { width: 90%; max-width: 400px; text-align: left; }
        .mood-stats-row { display: flex; justify-content: space-around; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 10px; text-align: center; }
        .mood-stat-item { display: flex; flex-direction: column; }
        .mood-stat-num { font-weight: bold; font-size: 1.2em; color: var(--primary); }
        .mood-history-list { max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px; }
        .mood-history-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f1f3f5; }
        .mood-history-date { color: #888; font-size: 0.9em; }

        .admin-toolbar { display: none; background: var(--admin-bar-bg); margin: 10px -20px -15px -20px; padding: 10px 20px; border-radius: 0 0 var(--radius) var(--radius); border-top: 1px solid rgba(0,0,0,0.1); align-items: center; gap: 10px; flex-wrap: wrap; animation: pop 0.3s; }
        .admin-label { font-weight: bold; font-size: 0.9em; color: var(--primary); display: flex; align-items: center; gap:5px;}
        .admin-btn { background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 0.8em; display: flex; align-items: center; gap: 5px;}
        .admin-btn:hover { background: var(--primary); color: white; }

        /* æŒ‡å—å¼¹çª— */
        .guide-modal { width: 90%; max-width: 600px; text-align: left; max-height: 85vh; padding: 0; overflow: hidden; display: flex; flex-direction: column; }
        .guide-header { padding: 15px 20px; background: var(--primary); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .guide-tabs { display: flex; background: #eee; }
        .guide-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; color: #666; }
        .guide-tab.active { border-bottom-color: var(--primary); color: var(--primary); background: white; font-weight: bold; }
        .guide-content { padding: 20px; overflow-y: auto; flex: 1; }
        .guide-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .guide-table th { background: #f8f9fa; text-align: left; padding: 8px; border-bottom: 2px solid #ddd; }
        .guide-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .guide-section h4 { color: var(--secondary); border-bottom: 1px dashed #eee; padding-bottom: 5px; margin-top: 20px; }
        .guide-section:first-child h4 { margin-top: 0; }
        .guide-close-btn { background: none; border: none; color: white; font-size: 1.2em; cursor: pointer; }

        /* é“¶è¡Œå¼¹çª— */
        .bank-modal { width: 90%; max-width: 350px; text-align: center; padding: 25px; }
        .bank-balance-row { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; font-size: 1.1em; background: #f8f9fa; padding: 15px; border-radius: 15px; }
        .bank-balance-item { display: flex; flex-direction: column; gap: 5px; }
        .bank-val { font-weight: bold; font-size: 1.3em; color: var(--primary); }
        .bank-tabs { display: flex; background: #eee; padding: 5px; border-radius: 25px; margin-bottom: 20px; }
        .bank-tab { flex: 1; border: none; background: none; padding: 8px; border-radius: 20px; cursor: pointer; color: #666; font-weight: bold; transition: 0.3s; }
        .bank-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .bank-quick-btns { display: flex; gap: 8px; justify-content: center; margin: 15px 0; }
        .bank-quick-btn { background: #e7f5ff; border: 1px solid #d0ebff; color: var(--primary); padding: 5px 12px; border-radius: 8px; cursor: pointer; }
        .bank-quick-btn:hover { background: var(--primary); color: white; }
        .btn-confirm { background: var(--habit-color); color: white; width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 1.1em; cursor: pointer; font-weight: bold; }
        
        /* å¿ƒæ„¿å¼¹çª— */
        .wish-input-group { margin-bottom: 15px; text-align: left; }
        .wish-input-group label { display: block; font-size: 0.9em; color: #666; margin-bottom: 5px; font-weight: bold; }
        .wish-input-group input { width: 100%; padding: 10px; border: 2px solid #eee; border-radius: 10px; font-family: var(--font); box-sizing: border-box; }
        .wish-modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-cancel { background: #eee; color: #666; border: none; padding: 8px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-save-wish { background: var(--wish-color); color: white; border: none; padding: 8px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @media (max-width: 700px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body data-theme="sky">

<div id="bg-anim-container"></div>

<!-- æ¯æ—¥å¿ƒæƒ…è¾“å…¥å¼¹çª— (V47 ä¿®æ­£ç‰ˆ) -->
<div id="moodModal" class="modal-overlay">
    <div class="mood-modal-content">
        <h2 class="mood-title">ğŸŒ¥ï¸ æ—©å®‰ï¼ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ</h2>
        <div class="mood-grid">
            <div class="mood-btn" onclick="recordMood('happy')">ğŸ˜„<small>å¼€å¿ƒ</small></div>
            <div class="mood-btn" onclick="recordMood('normal')">ğŸ˜<small>ä¸€èˆ¬</small></div>
            <div class="mood-btn" onclick="recordMood('sad')">ğŸ˜¢<small>éš¾è¿‡</small></div>
        </div>
        <p style="color:#888; font-size:0.9em;">è®°å½•ä¸‹æ¥çš„æ¯ä¸€å¤©éƒ½å¾ˆçè´µå“¦</p>
    </div>
</div>

<!-- å¿ƒæƒ…æŠ¥è¡¨å¼¹çª— -->
<div id="moodReportModal" class="modal-overlay" onclick="closeMoodReport()">
    <div class="modal mood-report-modal" onclick="event.stopPropagation()">
        <h3>ğŸ“Š å¿ƒæƒ…æœˆæŠ¥ (ä»…å®¶é•¿)</h3>
        <div id="moodReportStats" class="mood-stats-row"></div>
        <div id="moodReportList" class="mood-history-list"></div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="btn btn-add" onclick="closeMoodReport()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- é“¶è¡Œå¼¹çª— -->
<div id="bankModal" class="modal-overlay" onclick="closeBankModal()">
    <div class="modal bank-modal" onclick="event.stopPropagation()">
        <h3>ğŸ¦ æ˜Ÿæ˜Ÿå°é“¶è¡Œ</h3>
        <div class="bank-balance-row">
            <div class="bank-balance-item"><span class="bank-val" id="bankWalletVal">0</span><small>ğŸ‘› é’±åŒ…</small></div>
            <div style="font-size: 1.5em; color:#ccc;">â¡ï¸</div>
            <div class="bank-balance-item"><span class="bank-val" id="bankJarVal">0</span><small>ğŸ· å­˜é’±ç½</small></div>
        </div>
        <div class="bank-tabs">
            <button id="tabDeposit" class="bank-tab active" onclick="switchBankTab('deposit')">å­˜å…¥</button>
            <button id="tabWithdraw" class="bank-tab" onclick="switchBankTab('withdraw')">å–å‡º</button>
        </div>
        <div class="input-area">
            <input type="number" id="bankAmount" placeholder="è¾“å…¥æ•°é‡">
        </div>
        <div class="bank-quick-btns">
            <button class="bank-quick-btn" onclick="setBankAmount(10)">+10</button>
            <button class="bank-quick-btn" onclick="setBankAmount(50)">+50</button>
            <button class="bank-quick-btn" onclick="setBankAmount('all')">å…¨éƒ¨</button>
        </div>
        <button class="btn-confirm" onclick="executeBankTransaction()">ç¡®è®¤äº¤æ˜“</button>
    </div>
</div>

<!-- å¿ƒæ„¿è®¾å®šå¼¹çª— -->
<div id="wishSetupModal" class="modal-overlay" onclick="closeWishModal()">
    <div class="modal wish-modal-content" onclick="event.stopPropagation()">
        <h3 style="color: var(--wish-color); margin-top:0;">ğŸ¦„ è®¾å®šæˆ‘çš„å¿ƒæ„¿</h3>
        <div class="wish-input-group">
            <label>ğŸ æƒ³è¦ä»€ä¹ˆç¤¼ç‰©ï¼Ÿ</label>
            <input type="text" id="wishNameInput" placeholder="æ¯”å¦‚ï¼šä¹é«˜é£èˆ¹">
        </div>
        <div class="wish-input-group">
            <label>â­ éœ€è¦å¤šå°‘æ˜Ÿæ˜Ÿï¼Ÿ</label>
            <input type="number" id="wishCostInput" placeholder="æ¯”å¦‚ï¼š500">
        </div>
        <div class="wish-modal-btns">
            <button class="btn-cancel" onclick="closeWishModal()">å†æƒ³æƒ³</button>
            <button class="btn-save-wish" onclick="saveWishFromModal()">ç¡®å®šè®¾å®š</button>
        </div>
    </div>
</div>

<!-- å¸®åŠ©æŒ‡å—å¼¹çª— -->
<div id="guideModal" class="modal-overlay" onclick="closeGuide()">
    <div class="modal guide-modal" onclick="event.stopPropagation()">
        <div class="guide-header">
            <span>ğŸ“š æ©™å­æˆé•¿æŒ‡å—</span>
            <button class="guide-close-btn" onclick="closeGuide()">Ã—</button>
        </div>
        <div class="guide-tabs">
            <div class="guide-tab active" onclick="switchGuideTab('manual')">ğŸ“– æ“ä½œæ‰‹å†Œ</div>
            <div class="guide-tab" onclick="switchGuideTab('ref')">â­ åˆ†å€¼å‚è€ƒ</div>
        </div>
        <div id="guideContentManual" class="guide-content">
            <div class="guide-section"><h4>ğŸ å¿«é€Ÿå¼€å§‹</h4><p>1. æ¯å¤©æ‰“å¼€ï¼Œé€‰æ‹©ä»Šæ—¥å¿ƒæƒ… ğŸ˜Š<br>2. å®Œæˆå·¦ä¾§<b>æ¯æ—¥ä¹ æƒ¯</b><br>3. å®Œæˆå³ä¾§<b>ä»Šæ—¥è®¡åˆ’</b> (éœ€å®¶é•¿å®¡æ‰¹å®šä»·)<br>4. å­˜å…¥<b>å¿ƒæ„¿å­˜é’±ç½</b>æˆ–åœ¨<b>å°è¶…å¸‚</b>å…‘æ¢ï¼</p></div>
            <div class="guide-section"><h4>ğŸ’ æˆ‘çš„å®åº“</h4><p>ç›²ç›’æŠ½åˆ°çš„ç‰©å“å¥–åŠ±ä¼šå­˜æ”¾åœ¨è¿™é‡Œï¼Œç‚¹å‡»å³å¯ä½¿ç”¨/æ ¸é”€ã€‚</p></div>
            <div class="guide-section"><h4>ğŸ”’ å®¶é•¿æ¨¡å¼</h4><p>ç‚¹å‡»é¡¶éƒ¨ <b>ğŸ”’ å®¶é•¿æ¨¡å¼</b> æŒ‰é’®ï¼Œè¾“å…¥å¯†ç ï¼ˆé»˜è®¤ 1234ï¼‰è§£é”ã€‚è§£é”åå¯å®¡æ‰¹ä»»åŠ¡ã€ç®¡ç†å¥–åŠ±ã€æŸ¥çœ‹æŠ¥è¡¨ã€‚</p></div>
        </div>
        <div id="guideContentRef" class="guide-content" style="display:none;">
            <p style="color:#666; font-size:0.9em; margin-bottom:10px;">å»ºè®®åˆ†å€¼ï¼š</p>
            <div class="guide-section"><h4>ğŸ“š å­¦ä¹ ç±»</h4><table class="guide-table"><tr><th>ä»»åŠ¡</th><th>æ˜Ÿæ•°</th></tr><tr><td>æŒ‰æ—¶å®Œæˆä½œä¸š</td><td>5</td></tr><tr><td>ä¹¦å†™å·¥æ•´</td><td>+5</td></tr><tr><td>é˜…è¯» (20åˆ†)</td><td>5-10</td></tr></table></div>
            <div class="guide-section"><h4>ğŸ§¹ ç”Ÿæ´»ç±»</h4><table class="guide-table"><tr><th>ä»»åŠ¡</th><th>æ˜Ÿæ•°</th></tr><tr><td>æŒ‰æ—¶èµ·å±…</td><td>5</td></tr><tr><td>åˆ·ç‰™æ´—è„¸</td><td>2</td></tr><tr><td>æ•´ç†æˆ¿é—´</td><td>3-5</td></tr></table></div>
        </div>
    </div>
</div>

<!-- é¢„è®¾ -->
<div id="presetModal" class="modal-overlay" onclick="closePreset()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>âš¡ å¿«é€Ÿæ·»åŠ </h3>
        <div id="presetGrid" class="preset-grid"></div>
    </div>
</div>

<!-- ä¸“æ³¨æ—¶é’Ÿ -->
<div id="timerModal" class="timer-overlay" style="display: none !important;">
    <div id="timerSetup" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <h2 style="color:white; text-shadow:0 2px 5px rgba(0,0,0,0.5);">â±ï¸ ä¸“æ³¨æŒ‘æˆ˜</h2>
        <p style="color:#ddd; margin-bottom:20px;">1åˆ†é’Ÿ = 1é¢—æ˜Ÿ â­</p>
        <div id="timerPresetList" class="timer-select-grid"></div>
        <div style="margin-top: 30px;">
            <button class="btn btn-timer-lg btn-timer-stop" onclick="closeTimer()">âŒ ä¸ç”¨äº†</button>
        </div>
    </div>
    <div id="timerRunning" style="display:none; text-align:center;">
        <div class="timer-msg">æ­£åœ¨è¿›è¡Œï¼š<span id="timerTaskName">é˜…è¯»</span></div>
        <div class="timer-circle"><svg><circle r="125" cx="133" cy="133"></circle></svg><span id="timerDisplay">00:00</span></div>
        <div class="timer-msg" style="font-size: 0.9em">ä¿æŒä¸“æ³¨ï¼Œä¸è¦ç¦»å¼€é¡µé¢å“¦ï¼</div>
        <button class="btn btn-timer-lg btn-timer-stop" onclick="stopTimer()">ğŸ›‘ æ”¾å¼ƒæŒ‘æˆ˜</button>
    </div>
</div>

<div class="app-container">
    <div class="top-section">
        <div class="header-section">
            <div class="header-top">
                <div class="title-area">
                    <h1>ğŸŠ æ©™å­æˆé•¿Â·è¶…çº§è®¡åˆ’ <span id="todayMoodDisplay" class="mood-display"></span></h1>
                    <div style="font-size: 0.9em; opacity: 0.8;">
                        <span id="levelBadge" class="level-badge">Lv.1</span>
                        <span>ç´¯è®¡: <span id="totalStars">0</span> â­</span>
                    </div>
                </div>
                
                <div class="header-right-group">
                    <div class="tools-bar">
                        <button onclick="openGuide()" class="tool-btn">â“æŒ‡å—</button>
                        <button id="muteBtn" class="tool-btn" onclick="toggleMute()">ğŸ”Š</button>
                        <button id="globalLockBtn" class="tool-btn" onclick="toggleParentLock()">ğŸ”’å®¶é•¿æ¨¡å¼</button>
                        <select id="themeSelect" class="theme-select" onchange="changeTheme(this.value)">
                            <option value="sky">â˜ï¸ è“å¤©</option>
                            <option value="forest">ğŸŒ² æ£®æ—</option>
                            <option value="space">ğŸš€ å®‡å®™</option>
                            <option value="candy">ğŸ¬ ç³–æœ</option>
                        </select>
                    </div>
                    
                    <div class="points-display-area">
                        <span class="stars-label">å¯ç”¨ç§¯åˆ†</span>
                        <div class="stars-number-box">
                            <span class="stars-number" id="starCount">0</span>
                            <span class="stars-icon">â­</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="adminToolbar" class="admin-toolbar">
                <div class="admin-label">ğŸ”§ ç®¡ç†å‘˜åŠŸèƒ½:</div>
                <button class="admin-btn" onclick="openMoodReport()">ğŸ“Š å¿ƒæƒ…æŠ¥è¡¨</button>
                <button class="admin-btn" onclick="changePassword()">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
                <button class="admin-btn" onclick="exportData()">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
                <button class="admin-btn" onclick="document.getElementById('fileInput').click()">ğŸ“¥ æ¢å¤æ•°æ®</button>
                <button class="admin-btn" onclick="hardReset()" style="color:red; border-color:red;">âš ï¸ é‡ç½®ç³»ç»Ÿ</button>
            </div>
        </div>

        <div class="history-section">
            <div class="history-title">ğŸ“… æœ¬å‘¨æˆé•¿è¶³è¿¹</div>
            <div id="historyList" class="history-scroll"></div>
        </div>
    </div>

    <div class="main-grid">
        <!-- å·¦åˆ— -->
        <div class="left-column">
            <div class="panel habit-panel">
                <h2><span>ğŸ”„ æ¯æ—¥ä¹ æƒ¯</span> <button onclick="resetHabits()" style="font-size:0.6em; background:var(--accent); color:#fff; border:none; border-radius:5px; padding:5px; cursor:pointer;">æ–°çš„ä¸€å¤©</button></h2>
                <div id="habitList"></div>
                <div class="input-area">
                    <button class="btn btn-quick" onclick="openPreset('habit')" title="å¿«é€Ÿæ·»åŠ ">âš¡</button>
                    <input type="text" id="newHabitText" placeholder="ä¹ æƒ¯">
                    <input type="number" id="newHabitVal" class="val-input" value="2">
                    <button class="btn btn-add" onclick="addHabit()">+</button>
                </div>
            </div>

            <div class="panel reward-panel">
                <h2><div style="display:flex; align-items:center;"><span>ğŸ å¥–åŠ±ä¸­å¿ƒ</span></div></h2>
                
                <!-- ç‹¬ç«‹é“¶è¡Œç‰ˆå— -->
                <div class="bank-card">
                    <div class="bank-card-header">
                        <div class="bank-title">ğŸ¦ æ˜Ÿæ˜Ÿå°é“¶è¡Œ</div>
                    </div>
                    <div class="bank-dashboard-new">
                        <div class="bank-item-new">
                            <div class="bank-label-new">ğŸ‘› é›¶èŠ±é’± (å¯ç”¨)</div>
                            <div class="bank-val-new" id="dashWallet">0</div>
                        </div>
                        <div class="bank-icon-arrow">â¡</div>
                        <div class="bank-item-new">
                            <div class="bank-label-new">ğŸ· å°é‡‘åº“ (å·²å­˜)</div>
                            <div class="bank-val-new" id="dashBank">0</div>
                        </div>
                    </div>
                    <div class="bank-actions-row">
                        <button class="btn-bank-act btn-bank-dep" onclick="openBankModal('deposit')">â¬‡ï¸ å­˜å…¥</button>
                        <button class="btn-bank-act btn-bank-wit" onclick="openBankModal('withdraw')">â¬†ï¸ å–å‡º</button>
                    </div>
                </div>
                
                <div class="reward-sub-header wish-header-style">ğŸ’ æˆ‘çš„å®åº“ (ç‚¹å‡»ä½¿ç”¨)</div>
                <div id="inventoryList" class="inventory-grid"></div>

                <div class="reward-sub-header wish-header-style">
                    <span>ğŸ¦„ é•¿æœŸå¿ƒæ„¿</span>
                </div>
                <div class="wish-jar-container" id="wishJar"></div>
                
                <div class="reward-sub-header market-header-style">ğŸ›’ æ—¥å¸¸å°è¶…å¸‚ (å³æ—¶å…‘æ¢)</div>
                <div class="reward-grid" id="rewardList"></div>
                <div id="rewardInputArea" class="input-area" style="max-width: 100%; margin: 20px auto; display:none;">
                    <button class="btn btn-quick" onclick="openPreset('reward')" title="å¿«é€Ÿæ·»åŠ ">âš¡</button>
                    <input type="text" id="newRewardText" placeholder="æ–°å¥–åŠ±">
                    <input type="number" id="newRewardCost" class="val-input" value="20" placeholder="åˆ†å€¼">
                    <button class="btn btn-add" onclick="addReward()">æ·»åŠ å•†å“</button>
                </div>
            </div>
        </div>

        <!-- å³åˆ— -->
        <div class="right-column">
            <div class="focus-banner">
                <div class="focus-info"><h3>â±ï¸ ä¸“æ³¨æŒ‘æˆ˜</h3><p>1åˆ†é’Ÿ = 1é¢—æ˜Ÿå¥–åŠ±ï¼</p></div>
                <button class="focus-btn-start" onclick="openTimerModal()"><span>âš¡</span> å¼€å§‹</button>
            </div>

            <div class="panel plan-panel">
                <h2><span>ğŸ“… ä»Šæ—¥è®¡åˆ’</span> <span id="weekdayTip" style="font-size:0.6em; background:#ffc078; color:#fff; padding:2px 5px; border-radius:5px; display:none;">ğŸ“š ä½œä¸šå·²æ·»åŠ </span></h2>
                <div id="planList"></div>
                <div class="input-area">
                    <button class="btn btn-quick" onclick="openPreset('plan')" title="å¿«é€Ÿæ·»åŠ ">âš¡</button>
                    <input type="text" id="newPlanText" placeholder="è®¡åˆ’">
                    <input type="number" id="newPlanVal" class="val-input" value="5" style="display:none;"> 
                    <button class="btn btn-add" onclick="addPlan()">+</button>
                </div>
            </div>
            
            <div class="panel badge-panel">
                <h2><span>ğŸ† è£èª‰å‹‹ç« å¢™</span> <span style="font-size:0.6em; color:#999; font-weight:normal;">è‡ªåŠ¨è§£é”æˆå°±</span></h2>
                <div class="badge-grid" id="badgeList"></div>
            </div>
        </div>
    </div>
    
    <div style="grid-column: 1/-1; text-align: center; margin-top: 20px; border-top:1px solid #eee; padding-top:20px;">
        <input type="file" id="fileInput" style="display: none;" onchange="importData(this)">
        <div style="font-size: 0.8em; color: #aaa;">V47 - æ©™å­æˆé•¿Â·äº‘ç«¯å®è£…ç‰ˆ (Code by DeepSeek)</div>
        <div id="syncStatus">Initializing...</div>
    </div>
</div>

<script>
    // === 1. SUPABASE CONFIGURATION ===
    // âš ï¸ è¯·æŠŠä¸‹é¢çš„ URL å’Œ Key æ›¿æ¢æˆä½ è‡ªå·±çš„ï¼
    const supabaseUrl = 'https://yfqipywumroxanjiaagu.supabase.co'; 
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmcWlweXd1bXJveGFuamlhYWd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMDg1MTAsImV4cCI6MjA3OTc4NDUxMH0.JEu1LBQgOxoMLkBfFcv76P636LxyKEGRzhBSjg9VPIw'; 
    
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const DB_ID = 1; // å®¶åº­å”¯ä¸€ID (ç®€æ˜“ç‰ˆå†™æ­»ä¸º1)

    // --- æ•°æ®é€»è¾‘ ---
    const defaultData = { 
        stars: 0, totalStars: 0, theme: 'sky', pwd: '1234', lastLoginDate: '', isMuted: false,
        habits: [], plans: [], rewards: [], history: {}, inventory: [],
        focusPresets: [{id: 1, name: "ğŸ“– é˜…è¯»", min: 10, icon: "ğŸ“–"}, {id: 2, name: "âœï¸ å†™ä½œä¸š", min: 25, icon: "âœï¸"}, {id: 3, name: "ğŸ¹ ç»ƒç´", min: 45, icon: "ğŸ¹"}, {id: 4, name: "âš¡ æµ‹è¯•", min: 1, icon: "âš¡"}],
        wish: { name: null, cost: 0, saved: 0 }, moods: {}
    };
    
    const badgesDef = [
        { id: 'b_first', icon: 'ğŸŒ±', name: 'åˆæ¬¡è§é¢', desc: 'ç¬¬ä¸€æ¬¡ä½¿ç”¨ç³»ç»Ÿ', check: (s) => true },
        { id: 'b_rich1', icon: 'âœ¨', name: 'ç¬¬ä¸€æ¡¶é‡‘', desc: 'ç´¯è®¡è·å¾— 50 é¢—æ˜Ÿ', check: (s) => s.totalStars >= 50 },
        { id: 'b_rich2', icon: 'ğŸš€', name: 'å®‡èˆªå‘˜', desc: 'ç´¯è®¡è·å¾— 500 é¢—æ˜Ÿ', check: (s) => s.totalStars >= 500 },
        { id: 'b_streak', icon: 'ğŸ”¥', name: 'æ¯…åŠ›å¸', desc: 'ä»»æ„ä¹ æƒ¯è¿ç»­æ‰“å¡ 7 å¤©', check: (s) => s.habits.some(h => h.streak >= 7) },
        { id: 'b_wish',   icon: 'ğŸ¯', name: 'æ¢¦æƒ³å®¶', desc: 'è®¾å®šäº†ä¸€ä¸ªå¿ƒæ„¿ç›®æ ‡', check: (s) => s.wish && s.wish.name },
        { id: 'b_saver',  icon: 'ğŸ’', name: 'å°å¯Œç¿', desc: 'å½“å‰æ‹¥æœ‰è¶…è¿‡ 200 é¢—æ˜Ÿ', check: (s) => s.stars >= 200 },
        { id: 'b_focus',  icon: 'â±ï¸', name: 'ä¸“æ³¨è€…', desc: 'å®Œæˆè¿‡ä¸€æ¬¡ 25åˆ†é’Ÿä»¥ä¸Šä¸“æ³¨', check: (s) => s.plans.some(p => p.text.includes('ä¸“æ³¨') && p.val >= 25) }
    ];

    const presets = {
        habit: [{t:"æ—©ç¡æ—©èµ·", v:5}, {t:"åˆ·ç‰™æ´—è„¸", v:2}, {t:"æ•´ç†ä¹¦åŒ…", v:3}, {t:"é˜…è¯»20åˆ†é’Ÿ", v:5}],
        plan: [{t:"å®Œæˆè¯­æ–‡ä½œä¸š", v:1}, {t:"å®Œæˆæ•°å­¦ä½œä¸š", v:1}, {t:"èƒŒè¯µå¤è¯—", v:5}, {t:"ç”»ä¸€å¹…ç”»", v:15}],
        reward: [{t:"çœ‹ç”µè§†20åˆ†é’Ÿ", v:20, i:"ğŸ“º"}, {t:"ç©iPad 30åˆ†é’Ÿ", v:30, i:"ğŸ“±"}, {t:"ä¹°å¥¥ç‰¹æ›¼å¡ç‰‡", v:50, i:"ğŸƒ"}]
    };
    const levels = [{min:0, title:"ğŸ‘¶ èŒæ–°å°ç™½"}, {min:100, title:"ğŸƒâ€â™‚ï¸ è¿½é£å°‘å¹´"}, {min:300, title:"ğŸ’ª åšæŒè¾¾äºº"}, {min:600, title:"ğŸš€ å®‡å®™æ¢ç´¢è€…"}, {min:1000, title:"ğŸ‘‘ è£è€€ç‹è€…"}];

    let state = JSON.parse(JSON.stringify(defaultData));
    let isParentMode = false;
    let currentPresetType = '';
    let timerInterval = null;
    let totalSeconds = 0;
    let remainingSeconds = 0;
    let currentTaskVal = 0;
    let currentBankMode = 'deposit';

    // --- æ ¸å¿ƒï¼šäº‘ç«¯åˆå§‹åŒ– ---
    async function init() {
        updateSyncStatus('loading');
        
        try {
            let { data, error } = await supabase
                .from('user_data')
                .select('content')
                .eq('id', DB_ID)
                .single();

            if (error && error.code !== 'PGRST116') { 
                console.error('Cloud load error:', error);
                alert('äº‘ç«¯åŒæ­¥å‡ºé”™ï¼Œå°†ä½¿ç”¨æœ¬åœ°ç¼“å­˜ (è¯·æ£€æŸ¥æ§åˆ¶å°)');
                loadFromLocal();
            } else if (data && data.content) {
                console.log('Loaded from cloud:', data.content);
                state = { ...defaultData, ...data.content };
                if (!state.wish) state.wish = { name: null, cost: 0, saved: 0 };
                if (state.wish.saved === undefined) state.wish.saved = 0; 
                if (!state.moods) state.moods = {};
                if (!state.inventory) state.inventory = [];
                if (state.isMuted === undefined) state.isMuted = false;
                updateSyncStatus('success');
            } else {
                loadFromLocal();
                save(); 
            }
        } catch (err) {
            console.error(err);
            loadFromLocal();
        }

        state.habits = state.habits.length ? state.habits : [{id:Date.now(), text:"æ—©ç¡æ—©èµ·", val:5, done:false, streak:0, lastDate:''}];
        state.rewards = state.rewards.length ? state.rewards : [{id:Date.now()+2, text:"çœ‹ç”µè§†", cost:20, icon:"ğŸ“º"}];
        
        dailyCheck(); 
        checkMood(); 
        applyTheme(); 
        render(); 
        updateMuteBtn();
        
        document.getElementById('newPlanVal').style.display = isParentMode ? 'block' : 'none';
    }

    function loadFromLocal() {
        const saved = localStorage.getItem('kidPlanState_v47');
        if (saved) {
            try {
                state = { ...defaultData, ...JSON.parse(saved) };
            } catch(e) {}
        }
        updateSyncStatus('error');
    }

    async function save() {
        localStorage.setItem('kidPlanState_v47', JSON.stringify(state));
        
        document.getElementById('starCount').innerText = state.stars;
        document.getElementById('totalStars').innerText = state.totalStars;
        updateLevel(); renderHistory(); renderWish(); renderBadges(); renderBank(); renderInventory();

        updateSyncStatus('loading');
        const { error } = await supabase
            .from('user_data')
            .upsert({ id: DB_ID, content: state });

        if (error) {
            console.error('Cloud save error:', error);
            updateSyncStatus('error');
        } else {
            updateSyncStatus('success');
        }
    }

    function updateSyncStatus(status) {
        const el = document.getElementById('syncStatus');
        if(!el) return;
        if (status === 'loading') el.innerHTML = '<span class="sync-dot yellow"></span> æ­£åœ¨åŒæ­¥...';
        else if (status === 'success') el.innerHTML = '<span class="sync-dot green"></span> äº‘ç«¯å·²åŒæ­¥';
        else if (status === 'error') el.innerHTML = '<span class="sync-dot red"></span> åŒæ­¥å¤±è´¥(ç¦»çº¿)';
    }

    function dailyCheck() {
        const todayStr = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        state.habits.forEach(h => {
            if (!h.streak) h.streak = 0;
            if (h.lastDate !== todayStr && h.lastDate !== yesterday && h.streak > 0) h.streak = 0;
            if (h.lastDate !== todayStr) h.done = false;
        });
        if (state.lastLoginDate !== todayStr) {
            const dayOfWeek = new Date().getDay();
            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                state.plans.push({id: Date.now() + 10, text: "å®Œæˆè¯­æ–‡ä½œä¸š", val: 1, done: false});
                state.plans.push({id: Date.now() + 20, text: "å®Œæˆæ•°å­¦ä½œä¸š", val: 1, done: false});
                const tip = document.getElementById('weekdayTip');
                if(tip) { tip.style.display = 'inline-block'; setTimeout(() => tip.style.display='none', 5000); }
            }
            state.lastLoginDate = todayStr;
        }
    }

    function checkMood() {
        const today = new Date().toDateString();
        if (!state.moods[today]) { document.getElementById('moodModal').style.display = 'flex'; }
        else { showMoodIcon(state.moods[today]); }
    }
    function recordMood(mood) {
        const today = new Date().toDateString();
        state.moods[today] = mood; save(); document.getElementById('moodModal').style.display = 'none';
        if (mood === 'happy') confetti(); else if (mood === 'sad') alert("ğŸ«‚ æŠ±æŠ±ä½ ï¼åšæŒå®Œæˆä»»åŠ¡å°±æ˜¯å°è‹±é›„ï¼");
        showMoodIcon(mood);
    }
    function showMoodIcon(mood) { const map = { 'happy': 'ğŸ˜„', 'normal': 'ğŸ˜', 'sad': 'ğŸ˜¢' }; document.getElementById('todayMoodDisplay').innerText = map[mood] || ''; }
    
    function openGuide() { document.getElementById('guideModal').style.display = 'flex'; }
    function closeGuide() { document.getElementById('guideModal').style.display = 'none'; }
    function switchGuideTab(tab) {
        document.querySelectorAll('.guide-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.guide-content').forEach(c => c.style.display = 'none');
        if(tab === 'manual') {
            document.querySelector('.guide-tab:nth-child(1)').classList.add('active');
            document.getElementById('guideContentManual').style.display = 'block';
        } else {
            document.querySelector('.guide-tab:nth-child(2)').classList.add('active');
            document.getElementById('guideContentRef').style.display = 'block';
        }
    }

    function openMoodReport() {
        const list = document.getElementById('moodReportList');
        const statsDiv = document.getElementById('moodReportStats');
        list.innerHTML = '';
        let counts = { happy:0, normal:0, sad:0 };
        const dates = Object.keys(state.moods).sort((a,b) => new Date(b) - new Date(a));
        dates.forEach(d => {
            const m = state.moods[d];
            if(counts[m] !== undefined) counts[m]++;
            const map = { 'happy': 'ğŸ˜„ å¼€å¿ƒ', 'normal': 'ğŸ˜ ä¸€èˆ¬', 'sad': 'ğŸ˜¢ éš¾è¿‡' };
            const dateObj = new Date(d);
            const dateStr = `${dateObj.getMonth()+1}æœˆ${dateObj.getDate()}æ—¥`;
            list.innerHTML += `<div class="mood-history-item"><span class="mood-history-date">${dateStr}</span><span>${map[m]}</span></div>`;
        });
        statsDiv.innerHTML = `<div class="mood-stat-item"><span class="mood-stat-num">${counts.happy}</span><small>ğŸ˜„å¼€å¿ƒ</small></div><div class="mood-stat-item"><span class="mood-stat-num">${counts.normal}</span><small>ğŸ˜ä¸€èˆ¬</small></div><div class="mood-stat-item"><span class="mood-stat-num" style="color:#ff8787">${counts.sad}</span><small>ğŸ˜¢éš¾è¿‡</small></div>`;
        document.getElementById('moodReportModal').style.display = 'flex';
    }
    function closeMoodReport() { document.getElementById('moodReportModal').style.display = 'none'; }

    function renderBank() {
        document.getElementById('dashWallet').innerText = state.stars;
        document.getElementById('dashBank').innerText = state.wish.saved;
    }

    // --- V40 å¿ƒæ„¿çº¯å‡€ç‰ˆ (ä½¿ç”¨V37å¼¹çª—) ---
    function renderWish() {
        const container = document.getElementById('wishJar');
        if (!state.wish || !state.wish.name) {
            container.innerHTML = `
                <div class="wish-empty-card" onclick="openWishModal()" style="cursor:pointer;">
                    <span class="wish-empty-icon">ğŸ¯</span>
                    <div class="wish-empty-text">æš‚æ— å¿ƒæ„¿ç›®æ ‡</div>
                    <button class="wish-btn-set">ç‚¹å‡»è®¾å®š</button>
                </div>
            `;
        } else {
            const percent = Math.min(100, Math.floor((state.wish.saved / state.wish.cost) * 100));
            container.innerHTML = `
                <div class="wish-active-card">
                    <div class="wish-header-row">
                        <div class="wish-title-text">ğŸ¦„ ${state.wish.name}</div>
                        <button class="wish-btn-edit" onclick="openWishModal()">âœ ä¿®æ”¹</button>
                    </div>
                    <div class="wish-progress-bg"><div class="wish-progress-fill" style="width: ${percent}%"></div></div>
                    <div class="wish-stats">
                        <span>å·²å­˜: ${state.wish.saved}</span>
                        <span>ç›®æ ‡: ${state.wish.cost}</span>
                    </div>
                    <button class="wish-btn-redeem" onclick="redeemWish()">ğŸ å…‘æ¢å¿ƒæ„¿</button>
                </div>
            `;
        }
    }
    
    function openWishModal() {
        document.getElementById('wishSetupModal').style.display = 'flex';
        if(state.wish && state.wish.name) {
            document.getElementById('wishNameInput').value = state.wish.name;
            document.getElementById('wishCostInput').value = state.wish.cost;
        } else {
            document.getElementById('wishNameInput').value = '';
            document.getElementById('wishCostInput').value = '';
        }
    }
    function closeWishModal() { document.getElementById('wishSetupModal').style.display = 'none'; }
    
    function saveWishFromModal() {
        const name = document.getElementById('wishNameInput').value;
        const costStr = document.getElementById('wishCostInput').value;
        if(!name || !costStr) return alert("è¯·å¡«å†™å®Œæ•´å“¦ï¼");
        const cost = parseInt(costStr);
        if(isNaN(cost) || cost <= 0) return alert("æ˜Ÿæ˜Ÿæ•°é‡å¿…é¡»æ˜¯æ•°å­—ï¼");
        
        const currentSaved = state.wish ? (state.wish.saved || 0) : 0;
        state.wish = { name: name, cost: cost, saved: currentSaved }; 
        save(); confetti(); 
        closeWishModal();
    }

    function openBankModal(mode) {
        document.getElementById('bankModal').style.display = 'flex';
        switchBankTab(mode);
        updateBankUI();
    }
    function closeBankModal() { document.getElementById('bankModal').style.display = 'none'; }
    
    function switchBankTab(mode) {
        currentBankMode = mode;
        document.getElementById('tabDeposit').className = mode === 'deposit' ? 'bank-tab active' : 'bank-tab';
        document.getElementById('tabWithdraw').className = mode === 'withdraw' ? 'bank-tab active' : 'bank-tab';
        document.getElementById('bankAmount').placeholder = mode === 'deposit' ? 'è¾“å…¥å­˜å…¥é‡‘é¢' : 'è¾“å…¥å–å‡ºé‡‘é¢';
    }
    
    function updateBankUI() {
        document.getElementById('bankWalletVal').innerText = state.stars;
        document.getElementById('bankJarVal').innerText = state.wish.saved;
    }

    function setBankAmount(val) {
        const input = document.getElementById('bankAmount');
        if (val === 'all') {
            input.value = currentBankMode === 'deposit' ? state.stars : state.wish.saved;
        } else {
            input.value = val;
        }
    }

    function executeBankTransaction() {
        const valStr = document.getElementById('bankAmount').value;
        if (!valStr) return;
        const amount = parseInt(valStr);
        if (isNaN(amount) || amount <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—");

        if (currentBankMode === 'deposit') {
            if (amount > state.stars) return alert("é’±åŒ…ä½™é¢ä¸è¶³ï¼");
            state.stars -= amount;
            state.wish.saved += amount;
            playSound('success');
            confetti();
        } else {
            if (amount > state.wish.saved) return alert("å­˜é’±ç½ä½™é¢ä¸è¶³ï¼");
            state.wish.saved -= amount;
            state.stars += amount;
        }
        
        document.getElementById('bankAmount').value = '';
        updateBankUI();
        save();
        render(); 
        alert(currentBankMode === 'deposit' ? "âœ… å­˜å…¥æˆåŠŸï¼" : "âœ… å–å‡ºæˆåŠŸï¼");
        closeBankModal();
    }

    function redeemWish() { 
        if (!state.wish.name) return; 
        if (state.wish.saved >= state.wish.cost) { 
            if (confirm(`ğŸ‰ å­˜å¤Ÿå•¦ï¼\nç¡®å®šæ¶ˆè€—å­˜æ¬¾å…‘æ¢ [${state.wish.name}] å—ï¼Ÿ`)) { 
                state.wish.saved -= state.wish.cost; 
                state.wish = { name: null, cost: 0, saved: state.wish.saved }; 
                save(); playSound('redeem'); confetti(); alert("ğŸ¥³ æ­å–œä½ ï¼å¿«å»å®ç°æ„¿æœ›å§ï¼"); 
            } 
        } else { 
            alert(`ğŸ’ª å­˜æ¬¾è¿˜å·® ${state.wish.cost - state.wish.saved} é¢—æ˜Ÿæ˜Ÿï¼ŒåŠ æ²¹å­˜é’±ï¼`); 
        } 
    }

    function openMysteryBox() {
        if (state.stars < 30) return alert("æ˜Ÿæ˜Ÿä¸å¤Ÿå“¦ï¼Œç›²ç›’éœ€è¦ 30 é¢—æ˜Ÿï¼");
        if (!confirm("ç¡®å®šæ¶ˆè€— 30 é¢—æ˜Ÿå¼€å¯ç›²ç›’å—ï¼Ÿ")) return;
        state.stars -= 30; playSound('redeem');
        const rewards = [
            { txt: "ğŸ¬ å¥–åŠ±ä¸€é¢—ç³–æœ", type: "item", icon: "ğŸ¬" },
            { txt: "ğŸ“º çœ‹ç”µè§† 30åˆ†é’Ÿ", type: "item", icon: "ğŸ“º" },
            { txt: "ğŸ¦ åƒä¸ªå†°æ·‡æ·‹", type: "item", icon: "ğŸ¦" },
            { txt: "ğŸŸï¸ å…åšä¸€æ¬¡å®¶åŠ¡", type: "item", icon: "ğŸŸï¸" },
            { txt: "â­ é€€è¿˜ 5 é¢—æ˜Ÿ", type: "bad" },
            { txt: "â­ è·å¾— 50 é¢—æ˜Ÿå¤§å¥–ï¼", type: "legendary", add: 50 }
        ];
        const result = rewards[Math.floor(Math.random() * rewards.length)];
        if(result.add) { state.stars += result.add; state.totalStars += result.add; } 
        else if(result.type === 'bad') { state.stars += 5; state.totalStars += 5; }
        else if(result.type === 'item') {
            state.inventory.push({ id: Date.now(), name: result.txt, icon: result.icon });
        }
        save(); render(); confetti();
        setTimeout(() => alert(`ğŸ æ­å–œè·å¾—ï¼š${result.txt}`), 200);
    }
    
    function renderInventory() {
        const list = document.getElementById('inventoryList');
        if (state.inventory.length === 0) {
            list.innerHTML = `
                <div class="inventory-empty" style="grid-column: 1 / -1;">
                    <div class="inventory-empty-icon">ğŸ“¦</div>
                    <div style="font-size:0.8em;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æŠ½ç›²ç›’å¡«æ»¡å®ƒï¼</div>
                </div>
            `;
            return;
        }
        list.innerHTML = state.inventory.map((item, index) => `
            <div class="inventory-item" onclick="useInventoryItem(${index})">
                <div class="inventory-icon">${item.icon}</div>
                <div class="inventory-name">${item.name}</div>
                <button class="inventory-btn" style="font-size:0.7em; padding:2px 8px;">ä½¿ç”¨</button>
            </div>
        `).join('');
    }

    function useInventoryItem(index) {
        const item = state.inventory[index];
        if(confirm(`ç¡®å®šè¦ä½¿ç”¨ [${item.name}] å—ï¼Ÿä½¿ç”¨åå°†æ¶ˆå¤±ã€‚`)) {
            state.inventory.splice(index, 1);
            save();
            render();
            playSound('success');
            alert(`âœ… å·²ä½¿ç”¨ï¼š${item.name}ï¼Œå¿«å»äº«å—å§ï¼`);
        }
    }

    function renderBadges() {
        const container = document.getElementById('badgeList');
        container.innerHTML = badgesDef.map(b => {
            const unlocked = b.check(state);
            const cls = unlocked ? 'badge-card unlocked' : 'badge-card locked';
            const statusText = unlocked ? 'å·²è·å–' : 'æœªè§£é”';
            return `
                <div class="${cls}" data-desc="${b.desc}">
                    <div class="badge-icon">${b.icon}</div>
                    <div class="badge-name">${b.name}</div>
                    <div class="badge-status" style="font-size:0.6em; margin-top:2px; color:${unlocked?'#e67700':'#999'}">${statusText}</div>
                </div>
            `;
        }).join('');
    }

    function openTimerModal() { renderFocusPresets(); document.getElementById('timerModal').style.display = 'flex'; document.getElementById('timerSetup').style.display = 'flex'; document.getElementById('timerRunning').style.display = 'none'; }
    function closeTimer() { document.getElementById('timerModal').style.display = 'none'; }
    function renderFocusPresets() { const list = document.getElementById('timerPresetList'); let html = state.focusPresets.map(p => `<div class="timer-opt" onclick="startTimer(${p.min}, '${p.name}')"><div style="font-size:2em; margin-bottom:5px;">${p.icon || 'â±ï¸'}</div><div style="font-weight:bold; font-size:1em;">${p.name}</div><div style="font-size:0.8em; opacity:0.8">${p.min} åˆ†é’Ÿ</div>${isParentMode ? `<button class="timer-del-btn" onclick="event.stopPropagation(); delFocusPreset('${p.id}')">Ã—</button>` : ''}</div>`).join(''); if(isParentMode) html += `<div class="timer-opt add-new-focus" onclick="addFocusPreset()">+<br><small>æ·»åŠ </small></div>`; list.innerHTML = html; }
    function addFocusPreset() { if(!isParentMode) return alert("è¯·å…ˆè§£é”å®¶é•¿æ¨¡å¼"); const name = prompt("ä¸“æ³¨å†…å®¹:"); if(name) { const min = prompt("æ—¶é•¿(åˆ†):", "20"); if(min && !isNaN(min)) { state.focusPresets.push({id: Date.now(), name: name, min: parseInt(min), icon: "â±ï¸"}); save(); renderFocusPresets(); } } }
    function delFocusPreset(id) { if(!isParentMode) return; if(confirm("åˆ é™¤?")) { state.focusPresets = state.focusPresets.filter(p => String(p.id) !== String(id)); save(); renderFocusPresets(); } }
    function startTimer(minutes, taskName) { document.getElementById('timerSetup').style.display = 'none'; document.getElementById('timerRunning').style.display = 'block'; document.getElementById('timerTaskName').innerText = taskName; totalSeconds = minutes * 60; remainingSeconds = totalSeconds; currentTaskVal = Math.max(1, minutes); updateTimerDisplay(); timerInterval = setInterval(() => { remainingSeconds--; updateTimerDisplay(); if (remainingSeconds <= 0) { clearInterval(timerInterval); finishTimer(taskName); } }, 1000); }
    function updateTimerDisplay() { const m = Math.floor(remainingSeconds / 60).toString().padStart(2, '0'); const s = (remainingSeconds % 60).toString().padStart(2, '0'); document.getElementById('timerDisplay').innerText = `${m}:${s}`; const offset = 785 - (remainingSeconds / totalSeconds) * 785; document.querySelector('.timer-circle circle').style.strokeDashoffset = offset; }
    function stopTimer() { if(confirm("æ”¾å¼ƒæ²¡æœ‰æ˜Ÿæ˜Ÿå“¦?")) { clearInterval(timerInterval); closeTimer(); } }
    function finishTimer(taskName) { closeTimer(); state.stars += currentTaskVal; state.totalStars += currentTaskVal; logHistory(currentTaskVal); state.plans.push({id: Date.now(), text: `ä¸“æ³¨å®Œæˆï¼š${taskName}`, val: currentTaskVal, done: true}); save(); render(); playSound('success'); confetti(); alert(`ğŸ‰ å®Œæˆï¼è·å¾— ${currentTaskVal} æ˜Ÿï¼`); }

    function updateLevel() { let title = levels[0].title; for (let l of levels) { if (state.totalStars >= l.min) title = l.title; } document.getElementById('levelBadge').innerText = title; }
    function logHistory(amount) { const k = new Date().toDateString(); if (!state.history[k]) state.history[k] = 0; state.history[k] += amount; if(state.history[k] < 0) state.history[k] = 0; }
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function toggleMute() { state.isMuted = !state.isMuted; updateMuteBtn(); save(); }
    function updateMuteBtn() { const btn = document.getElementById('muteBtn'); btn.innerText = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; btn.style.opacity = state.isMuted ? '0.5' : '1'; }
    function playSound(type) { 
        if(state.isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); 
        if (type === 'success') { osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5); osc.start(); osc.stop(audioCtx.currentTime + 0.5); } 
        else if (type === 'redeem') { osc.type = 'triangle'; osc.frequency.setValueAtTime(300, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.6); osc.start(); osc.stop(audioCtx.currentTime + 0.6); } 
    }

    function render() {
        document.getElementById('starCount').innerText = state.stars;
        document.getElementById('totalStars').innerText = state.totalStars;
        updateLevel();
        document.getElementById('habitList').innerHTML = state.habits.map(i => `<div class="list-item habit-item"><div class="item-content"><strong>${i.text}</strong> ${i.streak > 0 ? `<span class="streak-fire">ğŸ”¥${i.streak}</span>` : ''}<small>+${i.val} â­</small></div><div><button class="btn btn-check" style="${i.done?'background:#ccc':''}" onclick="toggleHabit('${i.id}')">${i.done?'å·²å®Œæˆ':'æ‰“å¡'}</button><button class="btn btn-del" onclick="delItem('habits','${i.id}')">Ã—</button></div></div>`).join('');
        
        document.getElementById('planList').innerHTML = state.plans.map(i => {
            const isPending = i.pendingValue;
            let btnHtml = '';
            let valHtml = `<small>+${i.val} â­</small>`;
            if (i.done) { btnHtml = '<span style="color:#888; font-size:0.8em;">âœ… å·²å®Œæˆ</span>'; } 
            else if (isPending) {
                valHtml = `<small style="color:#ff922b;">â³ å¾…å®šä»·</small>`;
                if (isParentMode) { btnHtml = `<button class="btn btn-set-score" onclick="setPlanScore('${i.id}')">è®¾ç½®åˆ†å€¼</button>`; } 
                else { btnHtml = `<button class="btn btn-check" disabled style="background:#ccc; cursor:not-allowed;">ç­‰å¾…å®¶é•¿</button>`; }
            } else { btnHtml = `<button class="btn btn-check" onclick="finishPlan('${i.id}')">å®Œæˆ</button>`; }
            return `<div class="list-item plan-item ${isPending ? 'plan-pending' : ''}"><div class="item-content"><strong>${i.text}</strong>${valHtml}</div><div>${btnHtml} <button class="btn btn-del" onclick="delItem('plans','${i.id}')">Ã—</button></div></div>`;
        }).join('');
        
        let rewardsHtml = `<div class="mystery-box-card" onclick="openMysteryBox()"><span class="mystery-icon">ğŸ</span><div>å¹¸è¿ç›²ç›’</div><div style="font-size:0.8em; opacity:0.9">30 â­/æ¬¡</div></div>`;
        rewardsHtml += state.rewards.map(i => `<div class="reward-card" onclick="redeemReward('${i.id}')"><span class="reward-icon">${i.icon||'ğŸ'}</span><div>${i.text}</div><div style="color:var(--accent)">${i.cost} â­</div>${isParentMode ? `<button class="btn btn-del" onclick="event.stopPropagation();delItem('rewards','${i.id}')" style="position:absolute;top:0;right:0">Ã—</button>` : ''}</div>`).join('');
        document.getElementById('rewardList').innerHTML = rewardsHtml;
        
        // å¼ºåˆ¶åŒæ­¥è¾“å…¥æ¡†çŠ¶æ€
        document.getElementById('newPlanVal').style.display = isParentMode ? 'block' : 'none';
        
        renderHistory(); renderWish(); renderBadges(); renderInventory(); renderBank();
    }
    
    function addPlan() { 
        const t = document.getElementById('newPlanText').value; if (!t) return;
        const vInput = document.getElementById('newPlanVal');
        let val = 0; let pendingValue = false;
        // åŒé‡ä¿é™©
        if (isParentMode) { 
            val = parseInt(vInput.value) || 0; 
            pendingValue = false; 
        } else { 
            val = 0; 
            pendingValue = true; 
        }
        state.plans.push({id: Date.now(), text: t, val: val, done: false, pendingValue: pendingValue});
        document.getElementById('newPlanText').value = '';
        document.getElementById('newPlanVal').value = ''; // æ¸…ç©ºå€¼
        save(); render();
        if(!isParentMode) alert("å·²æäº¤è®¡åˆ’ï¼è¯·è®©å®¶é•¿è®¾ç½®å¥–åŠ±åˆ†å€¼å“¦ã€‚");
    }

    function setPlanScore(id) {
        if (!isParentMode) return;
        const i = state.plans.find(p => String(p.id) === String(id));
        if (i) {
            const newVal = prompt(`è¯·ä¸ºä»»åŠ¡ [${i.text}] è®¾ç½®åˆ†å€¼:`, "5");
            if (newVal && !isNaN(newVal)) { i.val = parseInt(newVal); i.pendingValue = false; save(); render(); }
        }
    }

    function renderHistory() { const c = document.getElementById('historyList'); c.innerHTML = ''; const today = new Date(); const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']; for(let i=6; i>=0; i--) { const d = new Date(today); d.setDate(d.getDate() - i); const score = state.history[d.toDateString()] || 0; let levelClass = 'h-level-0'; let icon = 'ğŸ¥š'; if(score > 0) { levelClass = 'h-level-1'; icon = 'ğŸŒ±'; } if(score >= 20) { levelClass = 'h-level-2'; icon = 'ğŸŠ'; } if(score >= 50) { levelClass = 'h-level-3'; icon = 'ğŸ‘‘'; } const div = document.createElement('div'); div.className = 'history-card'; div.innerHTML = `<div class="history-date">${i===0 ? 'ä»Šå¤©' : days[d.getDay()]}</div><div class="history-bubble ${levelClass}"><span>${icon}</span></div>`; c.appendChild(div); } }

    function toggleHabit(id) { const i = state.habits.find(h => String(h.id) === String(id)); if(i) { const today = new Date().toDateString(); if(!i.done) { i.done=true; i.lastDate = today; i.streak = (i.streak || 0) + 1; state.stars+=parseInt(i.val); state.totalStars+=parseInt(i.val); logHistory(parseInt(i.val)); playSound('success'); confetti(); } else if(confirm("æ’¤é”€?")) { i.done=false; state.stars-=parseInt(i.val); state.totalStars-=parseInt(i.val); logHistory(-parseInt(i.val)); if(i.streak > 0) i.streak--; } save(); render(); } }
    function finishPlan(id) { const idx = state.plans.findIndex(p => String(p.id) === String(id)); if (idx === -1) return; const val = parseInt(state.plans[idx].val); if(confirm(`âœ… å®Œæˆï¼+${val}æ˜Ÿï¼`)) { state.stars += val; state.totalStars += val; logHistory(val); state.plans.splice(idx,1); playSound('success'); save(); render(); confetti(); } }
    function redeemReward(id) { const i = state.rewards.find(r => String(r.id) === String(id)); if(i && state.stars>=i.cost && confirm(`å…‘æ¢ ${i.text}?`)) { state.stars-=i.cost; playSound('redeem'); save(); render(); alert("ğŸ‰ å…‘æ¢æˆåŠŸ!"); } else if(i) alert("æ˜Ÿæ˜Ÿä¸å¤Ÿ"); }
    function openPreset(type) { currentPresetType = type; document.getElementById('presetGrid').innerHTML = presets[type].map(p => `<div class="preset-btn" onclick="usePreset('${p.t}', ${p.v}, '${p.i||''}')">${p.i||''} ${p.t} (${p.v})</div>`).join(''); document.getElementById('presetModal').style.display = 'flex'; }
    function closePreset() { document.getElementById('presetModal').style.display = 'none'; }
    function usePreset(text, val) { if (currentPresetType === 'habit') { document.getElementById('newHabitText').value = text; document.getElementById('newHabitVal').value = val; } else if (currentPresetType === 'plan') { document.getElementById('newPlanText').value = text; document.getElementById('newPlanVal').value = val; } else if (currentPresetType === 'reward') { document.getElementById('newRewardText').value = text; document.getElementById('newRewardCost').value = val; } closePreset(); }
    function addHabit() { const t=document.getElementById('newHabitText'), v=document.getElementById('newHabitVal'); if(t.value){state.habits.push({id:Date.now(),text:t.value,val:parseInt(v.value),done:false,streak:0});t.value='';save();render();} }
    // addPlan is now customized above
    function addReward() { if(!isParentMode)return alert("éœ€è§£é”"); const t=document.getElementById('newRewardText'), c=document.getElementById('newRewardCost'); if(t.value){state.rewards.push({id:Date.now(),text:t.value,cost:parseInt(c.value),icon:'ğŸ'});t.value='';save();render();} }
    function delItem(t, id) { if(t==='rewards'&&!isParentMode)return alert("éœ€è§£é”"); if(confirm("åˆ é™¤?")) { state[t]=state[t].filter(i=>String(i.id)!==String(id)); save(); render(); } }
    function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); a.download = `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function importData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { try { const j = JSON.parse(e.target.result); if(j.habits&&confirm("è¦†ç›–æ•°æ®?")) { state=j; save(); applyTheme(); render(); alert("âœ… æ¢å¤æˆåŠŸ!"); } } catch(err) { alert("âŒ æ ¼å¼é”™è¯¯"); } }; r.readAsText(f); input.value = ''; }
    
    function toggleParentLock() { 
        const btn = document.getElementById('globalLockBtn');
        const toolbar = document.getElementById('adminToolbar');
        const inputArea = document.getElementById('rewardInputArea');
        const planValInput = document.getElementById('newPlanVal');

        if (isParentMode) { 
            isParentMode = false; render(); 
            btn.innerHTML = "ğŸ”’ å®¶é•¿æ¨¡å¼"; btn.classList.remove('unlocked');
            toolbar.style.display = 'none'; inputArea.style.display = 'none';
            planValInput.style.display = 'none';
        } else { 
            if (prompt("ğŸ” å¯†ç  (é»˜è®¤1234):") === state.pwd) { 
                isParentMode = true; render(); 
                btn.innerHTML = "ğŸ”“ ç®¡ç†æ¨¡å¼"; btn.classList.add('unlocked');
                toolbar.style.display = 'flex'; inputArea.style.display = 'flex';
                planValInput.style.display = 'block';
            } else alert("ğŸš« é”™è¯¯"); 
        } 
    }
    
    function changePassword(){ if(prompt("æ—§å¯†ç :")===state.pwd){const n=prompt("æ–°å¯†ç :");if(n){state.pwd=n;save();alert("âœ… å·²ä¿®æ”¹");}}else alert("ğŸš« é”™è¯¯"); }
    function resetHabits(){if(confirm("é‡ç½®ä¹ æƒ¯?")){state.habits.forEach(h=>h.done=false);save();render();}}
    function hardReset(){if(confirm("æ¸…ç©ºæ•°æ®?")){localStorage.clear();location.reload();}}
    function applyTheme() { const t = state.theme || 'sky'; document.body.setAttribute('data-theme', t); document.getElementById('themeSelect').value = t; updateBackgroundEffects(t); }
    function changeTheme(t) { state.theme = t; applyTheme(); save(); }
    function updateBackgroundEffects(theme) { const c = document.getElementById('bg-anim-container'); c.innerHTML = ''; if(theme==='sky') spawn(c,['â˜ï¸','ğŸŒ¤ï¸','ğŸ•Šï¸'], 'floatRight', 8); else if(theme==='forest') spawn(c,['ğŸƒ','ğŸ‚','ğŸ„'], 'fallDown', 12); else if(theme==='candy') spawn(c,['ğŸ¬','ğŸ­','ğŸˆ'], 'floatUp', 15); else if(theme==='space') { spawn(c,['âœ¨','â˜…','Â·'], 'twinkle', 40); spawn(c,['ğŸš€'], 'rocketFly', 3); spawn(c,['ğŸ›¸'], 'ufoFly', 3); spawn(c,['â˜„ï¸'], 'meteorShoot', 3); spawn(c,['ğŸª','ğŸŒ'], 'planetFloat', 4); } }
    function spawn(c, items, anim, count) { for(let i=0;i<count;i++){ const el=document.createElement('div'); el.className='anim-item'; el.innerText=items[Math.floor(Math.random()*items.length)]; el.style.left=Math.random()*100+'%'; let dur=Math.random()*10+10; 
        if(anim==='floatRight'){el.style.left='-50px';el.style.top=Math.random()*60+'%';} else if(anim==='floatUp'){el.style.top='100vh';} else if(anim==='fallDown'){el.style.top='-50px';} 
        else if(anim==='twinkle'){el.style.top=Math.random()*100+'%';el.style.fontSize=(Math.random()*15+5)+'px';dur=Math.random()*3+2;} 
        else if(anim==='rocketFly'){el.style.left='-100px';el.style.top=Math.random()*50+50+'%';el.style.fontSize='50px';dur=Math.random()*10+15;} 
        else if(anim==='ufoFly'){el.style.left='100%';el.style.top=Math.random()*40+'%';el.style.fontSize='40px';dur=Math.random()*10+20;} 
        else if(anim==='meteorShoot'){el.style.left=(Math.random()*50+50)+'%';el.style.top=(Math.random()*40)+'%';el.style.fontSize='40px';dur=Math.random()*5+5;el.style.animationIterationCount="infinite";}
        else if(anim==='planetFloat'){el.style.top=Math.random()*80+10+'%';el.style.fontSize=(Math.random()*30+20)+'px';dur=Math.random()*10+10;}
        if(!el.style.fontSize) el.style.fontSize=(Math.random()*20+15)+'px'; el.style.animation=`${anim} ${dur}s linear infinite`; el.style.animationDelay=`${Math.random()*-20}s`; c.appendChild(el); } }
    function confetti(){const c=['#f00','#0f0','#00f','#ff0'];for(let i=0;i<30;i++){let d=document.createElement('div');d.style.cssText=`position:fixed;z-index:999;left:${Math.random()*100}vw;top:0;width:8px;height:8px;background:${c[Math.floor(Math.random()*4)]};transition:1s`;document.body.appendChild(d);setTimeout(()=>{d.style.top='100vh';d.style.opacity=0},10);setTimeout(()=>{d.remove()},1000);}}

    window.onload = init;
</script>
</body>
</html>